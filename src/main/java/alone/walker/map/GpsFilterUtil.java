package alone.walker.map;

import alone.walker.map.baidu.Points;
import com.alibaba.fastjson.JSON;
import lombok.extern.slf4j.Slf4j;

import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.LinkedList;
import java.util.List;

/**
 * @Author: huangYong
 * @Date: 2020/9/14 15:12
 */
@Slf4j
public class GpsFilterUtil {
    private List<Points> mListPoint = new ArrayList<>();
    private Boolean isFirst = true;         // 是否是第一次定位点
    private Boolean isSecond = true;        // 是否是第二次定位点
    private Points weight1 = new Points();  // 权重点1
    private Points weight2 = new Points();  // 权重点2
    final int ACCELERATION_MAX = 2;         // 单位 m/t^2

    public void gpsFilter(Points aMapLocation) {
        try {
            if (isFirst) {
                isFirst = false;
                weight1.setLatitude(aMapLocation.getLatitude());
                weight1.setLongitude(aMapLocation.getLongitude());
                weight1.setLoc_time(aMapLocation.getLoc_time());
            } else if (isSecond) {
                isSecond = false;
                weight2.setLatitude(aMapLocation.getLatitude());
                weight2.setLongitude(aMapLocation.getLongitude());
                weight2.setLoc_time(aMapLocation.getLoc_time());
            } else {
                double firstDis = LocationUtils.latAndLonDistance(weight1.getLongitude(), weight1.getLatitude(), weight2.getLongitude(), weight2.getLatitude());
                Long firstTime = weight1.getLoc_time() - weight2.getLoc_time();
                double secondDis = LocationUtils.latAndLonDistance(weight2.getLongitude(), weight2.getLatitude(), aMapLocation.getLongitude(), aMapLocation.getLatitude());
                Long secondTime = weight2.getLoc_time() - aMapLocation.getLoc_time();
                BigDecimal divide = null;
                try {
                    divide = new BigDecimal(firstDis).divide(new BigDecimal(firstTime), 2, BigDecimal.ROUND_HALF_UP)
                            .subtract(new BigDecimal(secondDis).divide(new BigDecimal(secondTime), 2, BigDecimal.ROUND_HALF_UP))
                            .divide(new BigDecimal(secondTime), 2, BigDecimal.ROUND_HALF_UP);
                } catch (Exception e) {
                    e.printStackTrace();
                }
                //加速度小于2
                final Points Points = new Points();
                Points.setLatitude(aMapLocation.getLatitude());
                Points.setLongitude(aMapLocation.getLongitude());
                Points.setLoc_time(aMapLocation.getLoc_time());
                Points.setAcceleration(divide.abs());
                mListPoint.add(Points);
                weight1.setLatitude(weight2.getLatitude());
                weight1.setLongitude(weight2.getLongitude());
                weight1.setLoc_time(weight2.getLoc_time());
                weight2.setLatitude(aMapLocation.getLatitude());
                weight2.setLongitude(aMapLocation.getLongitude());
                weight2.setLoc_time(aMapLocation.getLoc_time());
            }
        } catch (Exception e) {
        }
    }


    public List<Points> Points(List<Points> pointsList) {
        pointsList.forEach(this::gpsFilter);
        List<Points> result = new LinkedList<>();
        List<Integer> indexList = new ArrayList<>();
        for (int i = 0; i < mListPoint.size(); i++) {
            Points points = mListPoint.get(i);
            if (points.getAcceleration().floatValue() > ACCELERATION_MAX) {
                if (i > 1) {
                    indexList.add(i - 2);
                    indexList.add(i - 1);
                } else if (i > 0) {
                    indexList.add(i - 1);
                }
                indexList.add(i);
                indexList.add(i + 1);
                indexList.add(i + 2);
            }
        }
        for (int i = 0; i < mListPoint.size(); i++) {
            if (!indexList.contains(i)) {
                result.add(mListPoint.get(i));
            }
        }
        return result;
    }

    public static void main(String[] args) {
        Object[][] objects = {
                {
                        120.549405,
                        31.289877,
                        0.0,
                        0,
                        1599612898
                },
                {
                        120.548670,
                        31.290548,
                        0.0,
                        0,
                        1599612963
                },
                {
                        120.549027,
                        31.290031,
                        0.0,
                        0,
                        1599612968
                },
                {
                        120.548049,
                        31.291043,
                        0.0,
                        0,
                        1599613008
                },
                {
                        120.548180,
                        31.291043,
                        0.0,
                        0,
                        1599613034
                },
                {
                        120.547622,
                        31.290187,
                        0.0,
                        0,
                        1599613038
                },
                {
                        120.548190,
                        31.289272,
                        0.0,
                        0,
                        1599613175
                },
                {
                        120.549373,
                        31.290230,
                        0.0,
                        0,
                        1599613369
                },
                {
                        120.549356,
                        31.290228,
                        0.0,
                        0,
                        1599613433
                },
                {
                        120.549356,
                        31.290047,
                        0.0,
                        0,
                        1599613451
                },
                {
                        120.549360,
                        31.289864,
                        0.0,
                        0,
                        1599613497
                },
                {
                        120.549434,
                        31.289856,
                        0.0,
                        0,
                        1599613656
                },
                {
                        120.549434,
                        31.289856,
                        0.0,
                        0,
                        1599613658
                },
                {
                        120.549372,
                        31.289873,
                        0.0,
                        0,
                        1599613667
                },
                {
                        120.549372,
                        31.289880,
                        0.0,
                        0,
                        1599613674
                },
                {
                        120.549372,
                        31.289873,
                        0.0,
                        0,
                        1599613702
                },
                {
                        120.549395,
                        31.289861,
                        0.0,
                        0,
                        1599613737
                },
                {
                        120.549404,
                        31.289884,
                        0.0,
                        0,
                        1599613756
                },
                {
                        120.547425,
                        31.288865,
                        0.0,
                        0,
                        1599613981
                },
                {
                        120.547574,
                        31.288993,
                        0.0,
                        0,
                        1599614041
                },
                {
                        120.547639,
                        31.289128,
                        0.0,
                        0,
                        1599614101
                },
                {
                        120.547633,
                        31.289156,
                        0.0,
                        0,
                        1599614106
                },
                {
                        120.547643,
                        31.289235,
                        0.0,
                        0,
                        1599614121
                },
                {
                        120.547635,
                        31.289275,
                        0.0,
                        0,
                        1599614131
                },
                {
                        120.547619,
                        31.289295,
                        0.0,
                        0,
                        1599614142
                },
                {
                        120.547609,
                        31.289295,
                        0.0,
                        0,
                        1599614146
                },
                {
                        120.547555,
                        31.289315,
                        0.0,
                        0,
                        1599614342
                },
                {
                        120.547615,
                        31.289338,
                        0.0,
                        0,
                        1599614402
                },
                {
                        120.547613,
                        31.289336,
                        0.0,
                        0,
                        1599614407
                },
                {
                        120.547602,
                        31.289328,
                        0.0,
                        0,
                        1599614417
                },
                {
                        120.547632,
                        31.289290,
                        0.0,
                        0,
                        1599614432
                },
                {
                        120.547632,
                        31.289280,
                        0.0,
                        0,
                        1599614437
                },
                {
                        120.547635,
                        31.289269,
                        0.0,
                        0,
                        1599614442
                },
                {
                        120.547862,
                        31.289303,
                        0.0,
                        0,
                        1599614642
                },
                {
                        120.547942,
                        31.289318,
                        0.0,
                        0,
                        1599614702
                },
                {
                        120.547942,
                        31.289318,
                        0.0,
                        0,
                        1599614707
                },
                {
                        120.549139,
                        31.288634,
                        0.0,
                        0,
                        1599614732
                },
                {
                        120.549139,
                        31.288634,
                        0.0,
                        0,
                        1599614737
                },
                {
                        120.549149,
                        31.288627,
                        0.0,
                        0,
                        1599614742
                },
                {
                        120.549136,
                        31.288639,
                        0.0,
                        0,
                        1599614762
                },
                {
                        120.548516,
                        31.291700,
                        0.0,
                        0,
                        1599614882
                },
                {
                        120.547856,
                        31.289327,
                        0.0,
                        0,
                        1599614942
                },
                {
                        120.549023,
                        31.289163,
                        0.0,
                        0,
                        1599615002
                },
                {
                        120.549023,
                        31.289256,
                        0.0,
                        0,
                        1599615007
                },
                {
                        120.548607,
                        31.289437,
                        0.0,
                        0,
                        1599615027
                },
                {
                        120.548607,
                        31.289437,
                        0.0,
                        0,
                        1599615032
                },
                {
                        120.548747,
                        31.290308,
                        0.0,
                        0,
                        1599615037
                },
                {
                        120.548747,
                        31.290308,
                        0.0,
                        0,
                        1599615042
                },
                {
                        120.548328,
                        31.290382,
                        0.0,
                        0,
                        1599615062
                },
                {
                        120.548074,
                        31.289388,
                        0.0,
                        0,
                        1599615123
                },
                {
                        120.547489,
                        31.289259,
                        0.0,
                        0,
                        1599615243
                },
                {
                        120.548860,
                        31.289550,
                        0.0,
                        0,
                        1599615303
                },
                {
                        120.548713,
                        31.289449,
                        0.0,
                        0,
                        1599615308
                },
                {
                        120.548713,
                        31.289449,
                        0.0,
                        0,
                        1599615313
                },
                {
                        120.548816,
                        31.289281,
                        0.0,
                        0,
                        1599615333
                },
                {
                        120.548932,
                        31.288979,
                        0.0,
                        0,
                        1599615338
                },
                {
                        120.548932,
                        31.288979,
                        0.0,
                        0,
                        1599615343
                },
                {
                        120.548873,
                        31.289843,
                        0.0,
                        0,
                        1599615543
                },
                {
                        120.548526,
                        31.288884,
                        0.0,
                        0,
                        1599615603
                },
                {
                        120.548697,
                        31.288749,
                        0.0,
                        0,
                        1599615608
                },
                {
                        120.548697,
                        31.288615,
                        0.0,
                        0,
                        1599615623
                },
                {
                        120.549077,
                        31.289073,
                        0.0,
                        0,
                        1599615638
                },
                {
                        120.549077,
                        31.289073,
                        0.0,
                        0,
                        1599615643
                },
                {
                        120.548270,
                        31.289261,
                        0.0,
                        0,
                        1599615723
                },
                {
                        120.549362,
                        31.289865,
                        0.0,
                        0,
                        1599615903
                },
                {
                        120.549356,
                        31.289865,
                        0.0,
                        0,
                        1599615908
                },
                {
                        120.549330,
                        31.289786,
                        0.0,
                        0,
                        1599615918
                },
                {
                        120.548836,
                        31.289701,
                        0.0,
                        0,
                        1599615928
                },
                {
                        120.548534,
                        31.289633,
                        0.0,
                        0,
                        1599615938
                },
                {
                        120.548430,
                        31.289611,
                        0.0,
                        0,
                        1599615943
                },
                {
                        120.548460,
                        31.289624,
                        0.0,
                        0,
                        1599615963
                },
                {
                        120.549251,
                        31.289867,
                        0.0,
                        0,
                        1599616204
                },
                {
                        120.547887,
                        31.289670,
                        0.0,
                        0,
                        1599616234
                },
                {
                        120.547215,
                        31.289473,
                        0.0,
                        0,
                        1599616239
                },
                {
                        120.547351,
                        31.289389,
                        0.0,
                        0,
                        1599616244
                },
                {
                        120.547512,
                        31.289205,
                        0.0,
                        0,
                        1599616444
                },
                {
                        120.548237,
                        31.289216,
                        0.0,
                        0,
                        1599616504
                },
                {
                        120.548303,
                        31.289244,
                        0.0,
                        0,
                        1599616509
                },
                {
                        120.547904,
                        31.289160,
                        0.0,
                        0,
                        1599616622
                },
                {
                        120.547904,
                        31.289175,
                        0.0,
                        0,
                        1599616682
                },
                {
                        120.547919,
                        31.289232,
                        0.0,
                        0,
                        1599616743
                },
                {
                        120.547866,
                        31.289234,
                        0.0,
                        0,
                        1599616748
                },
                {
                        120.547694,
                        31.289223,
                        0.0,
                        0,
                        1599616793
                },
                {
                        120.547719,
                        31.289218,
                        0.0,
                        0,
                        1599616798
                },
                {
                        120.547838,
                        31.289187,
                        0.0,
                        0,
                        1599616843
                },
                {
                        120.547816,
                        31.289177,
                        0.0,
                        0,
                        1599616858
                },
                {
                        120.547788,
                        31.289177,
                        0.0,
                        0,
                        1599616868
                },
                {
                        120.547731,
                        31.289164,
                        0.0,
                        0,
                        1599616883
                },
                {
                        120.547711,
                        31.289167,
                        0.0,
                        0,
                        1599616888
                },
                {
                        120.547703,
                        31.289171,
                        0.0,
                        0,
                        1599616893
                },
                {
                        120.547701,
                        31.289194,
                        0.0,
                        0,
                        1599616903
                },
                {
                        120.547700,
                        31.289207,
                        0.0,
                        0,
                        1599616908
                },
                {
                        120.547715,
                        31.289224,
                        0.0,
                        0,
                        1599616918
                },
                {
                        120.547732,
                        31.289235,
                        0.0,
                        0,
                        1599616938
                },
                {
                        120.547613,
                        31.289161,
                        0.0,
                        0,
                        1599616978
                },
                {
                        120.547606,
                        31.289147,
                        0.0,
                        0,
                        1599616983
                },
                {
                        120.547611,
                        31.289093,
                        0.0,
                        0,
                        1599617008
                },
                {
                        120.547608,
                        31.289088,
                        0.0,
                        0,
                        1599617013
                },
                {
                        120.547628,
                        31.289089,
                        0.0,
                        0,
                        1599617033
                },
                {
                        120.547644,
                        31.289113,
                        0.0,
                        0,
                        1599617043
                },
                {
                        120.547638,
                        31.289162,
                        0.0,
                        0,
                        1599617063
                },
                {
                        120.547572,
                        31.289158,
                        0.0,
                        0,
                        1599617083
                },
                {
                        120.547568,
                        31.289158,
                        0.0,
                        0,
                        1599617093
                },
                {
                        120.547560,
                        31.289160,
                        0.0,
                        0,
                        1599617098
                },
                {
                        120.547549,
                        31.289160,
                        0.0,
                        0,
                        1599617103
                },
                {
                        120.547472,
                        31.289116,
                        0.0,
                        0,
                        1599617163
                },
                {
                        120.547484,
                        31.289199,
                        0.0,
                        0,
                        1599617283
                },
                {
                        120.547581,
                        31.289212,
                        0.0,
                        0,
                        1599617343
                },
                {
                        120.547581,
                        31.289213,
                        0.0,
                        0,
                        1599617348
                },
                {
                        120.547526,
                        31.289225,
                        0.0,
                        0,
                        1599617368
                },
                {
                        120.547497,
                        31.289224,
                        0.0,
                        0,
                        1599617378
                },
                {
                        120.547492,
                        31.289227,
                        0.0,
                        0,
                        1599617388
                },
                {
                        120.547485,
                        31.289228,
                        0.0,
                        0,
                        1599617398
                },
                {
                        120.547791,
                        31.289296,
                        0.0,
                        0,
                        1599617523
                },
                {
                        120.547699,
                        31.289383,
                        0.0,
                        0,
                        1599617583
                },
                {
                        120.547659,
                        31.289305,
                        0.0,
                        0,
                        1599617644
                },
                {
                        120.547830,
                        31.289221,
                        0.0,
                        0,
                        1599617679
                },
                {
                        120.547995,
                        31.289241,
                        0.0,
                        0,
                        1599617694
                },
                {
                        120.548062,
                        31.289250,
                        0.0,
                        0,
                        1599617699
                },
                {
                        120.548121,
                        31.289264,
                        0.0,
                        0,
                        1599617704
                },
                {
                        120.548935,
                        31.289036,
                        0.0,
                        0,
                        1599617824
                },
                {
                        120.547530,
                        31.289509,
                        0.0,
                        0,
                        1599617944
                },
                {
                        120.547525,
                        31.289402,
                        0.0,
                        0,
                        1599617974
                },
                {
                        120.547676,
                        31.289386,
                        0.0,
                        0,
                        1599617984
                },
                {
                        120.547834,
                        31.289397,
                        0.0,
                        0,
                        1599617999
                },
                {
                        120.547845,
                        31.289399,
                        0.0,
                        0,
                        1599618184
                },
                {
                        120.547768,
                        31.289398,
                        0.0,
                        0,
                        1599618244
                },
                {
                        120.547759,
                        31.289335,
                        0.0,
                        0,
                        1599618249
                },
                {
                        120.547753,
                        31.289273,
                        0.0,
                        0,
                        1599618254
                },
                {
                        120.547762,
                        31.289072,
                        0.0,
                        0,
                        1599618289
                },
                {
                        120.547757,
                        31.289116,
                        0.0,
                        0,
                        1599618294
                },
                {
                        120.547241,
                        31.289385,
                        0.0,
                        0,
                        1599618600
                },
                {
                        120.546504,
                        31.289390,
                        0.0,
                        0,
                        1599618660
                }
        };

        List<Points> pointsList = new ArrayList<>();
        for (Object[] doubles : objects) {
            Points traceLocation = new Points();
            traceLocation.setCoord_type_input("gcj02");
            traceLocation.setLongitude((Double) doubles[0]);
            traceLocation.setLatitude((Double) doubles[1]);
            traceLocation.setLoc_time(Long.parseLong(doubles[4].toString()));
            pointsList.add(traceLocation);
        }
        GpsFilterUtil gpsFilterUtil = new GpsFilterUtil();
        List<Points> PointsList = gpsFilterUtil.Points(pointsList);
        Double[][] geocodeArray = new Double[PointsList.size()][2];
        for (int i = 0; i < PointsList.size(); i++) {
            Points position = PointsList.get(i);
            geocodeArray[i][0] = position.getLongitude();
            geocodeArray[i][1] = position.getLatitude();
        }
        log.info(JSON.toJSONString(geocodeArray));
    }
}
